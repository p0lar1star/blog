# 恶意代码攻击溯源

## 一、序言

恶意代码溯源分析与研究工作。其基本思路是：

### 同源分析

利用恶意样本间的同源关系发现溯源痕迹，并根据它们出现的前后关系判定变体来源。恶意代码同源性分析，其目的是判断不同的恶意代码是否源自同一套恶意代码或是否由同一个作者、团队编写，其是否具有内在关联性、相似性。**从溯源目标上来看，可分为恶意代码家族溯源及作者溯源。**

#### 家族溯源：判断不同的恶意代码是否源自同一套恶意代码

家族变体是已有恶意代码在不断的对抗或功能进化中生成的新型恶意代码，针对变体的家族溯源是通过提取其特征数据及代码片段，分析它们与已知样本的同源关系，进而推测可疑恶意样本的家族。例如，Kinable等人提取恶意代码的系统调用图，采用图匹配的方式比较恶意代码的相似性，识别出同源样本，进行家族分类。

#### 作者溯源：是否由同一个作者、团队编写

恶意代码作者溯源即通过分析和提取恶意代码的相关特征，定位出恶意代码作者特征，揭示出样本间的同源关系，进而溯源到已知的作者或组织。例如，Gostev等通过分析Stuxnet与Duqu所用的驱动文件在编译平台、时间、代码等方面的同源关系，实现了对它们作者的溯源。2015年，针对中国的某APT攻击采用了至少4种不同的程序形态、不同编码风格和不同攻击原理的木马程序，潜伏3年之久，最终360天眼利用多维度的“大数据”分析技术进行同源性分析，进而溯源到“海莲花”黑客组织。

## 二、恶意代码攻击溯源的相关案例

**恶意代码溯源：** 是指通过分析恶意代码生成、传播的规律以及恶意代码之间衍生的关联性，基于目标恶意代码的特性实现对恶意代码源头的追踪。了解恶意代码的演化，有助于更好地把握恶意代码的发展趋势，为攻击追踪溯源提供相关启示。

非网络安全的现实案例：铁人王进喜

Lazarus溯源：对APT组织进行追踪需要一定的积累，只有熟悉了该组织的**常用攻击手法**（TTPs），才能在新型的攻击中将其辨识出来。其中，通过**样本共用代码段进行关联**是最高效的方式，这也突显了**使用yara规则进行样本分析**的好处。

首先，我们需要**从已有的样本中筛选出相同的特征码**，可以**使用Bindiff来比较已有样本相似的代码片段**，如下：找到相似度较高且不是系统API的函数。

![20191225215030681](%E6%BA%AF%E6%BA%90.assets/20191225215030681.png)

然后优先选取Blocks数较多、匹配指令数较多的函数。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805158.png)

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805221.png)

可以重点挑选一些加密算法代码作为特征码，这样比较没那么容易误报。除此之外，也可以使用一些**自动化提取yara规则的工具**，比如yargen：https://github.com/Neo23x0/yarGen。

如下，是提取出来的wannacry的特征码，可以在VT上进行关联，来追踪Lazarus的相似攻击组件。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805702.png)

## 三、学术界恶意代码溯源

学术界旨在**采用静态或动态的方式**获取恶意代码的特征信息，通过对恶意代码的特征学习，**建立不同类别恶意代码的特征模型**，通过**计算待检测恶意代码针对不同特征类别的相似性度量**，指导恶意代码的同源性判定。常见的恶意代码溯源主要包括4个阶段：**特征提取、特征预处理、相似性计算、同源判定**，各阶段间的流程关系如下图所示。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805394.png)

### 1.特征提取

**特征提取是溯源分析过程的基础**，具有同源性的恶意代码是通过它们的共有特征与其他代码区分开来的。**所提取的特征既要反映出恶意代码的本质和具有同源性恶意代码之间的相似性，又要满足提取的有效性。**(即和其他代码的区分性)

依据溯源目的，**溯源特征提取包括溯源家族的特征提取和溯源作者的特征提取**。Faruki等在**字节码级别**提取统计性强的序列特征，包括指令、操作码、字节码、API代码序列等。Perdisci R等**通过n-gram提取字节码序列作为特征**。Ki Y等提出了**捕获运行过程中的API序列作为特征**，**利用生物基因序列检测工具ClustalX对API序列进行相似性分析**，得到恶意代码的同源性判定。DNADroid使用PDG作为特征，DroidSim是一种基于组件的CFG来表示相似性代码特征，与早期的方法相比，该系统检测代码重用更准确。

<!--注：N-Gram是一种基于统计语言模型的算法。它的基本思想是将文本里面的内容按照字节进行大小为N的滑动窗口操作，形成了长度是N的字节片段序列。每一个字节片段称为gram，对所有gram的出现频度进行统计，并且按照事先设定好的阈值进行过滤，形成关键gram列表，也就是这个文本的向量特征空间，列表中的每一种gram就是一个特征向量维度。-->

N-Gram模型：N-gram模型是一种语言模型（Language Model，LM），语言模型是一个基于概率的判别模型，它的输入是一句话（单词的顺序序列），输出是这句话的概率，即这些单词的联合概率（joint probability）

[自然语言处理NLP中的N-gram模型_songbinxu的博客-CSDN博客_n-gram](https://blog.csdn.net/songbinxu/article/details/80209197)

[了解N-Gram模型 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/34219483)

[n-gram什么意思 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/263810552)

[N-gram 特征提取_ouprince-CSDN博客_n-gram特征](https://blog.csdn.net/qq_32023541/article/details/80089020)

[自然语言处理中N-Gram模型介绍 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/32829048)

### 2.特征预处理

特征提取过程中会遇到不具有代表性、不能量化的原始特征，特征预处理针对这一问题进行解决，以**提取出适用于相似性计算的代表性特征**。特征预处理一方面对初始特征进行预处理，另一方面为相似性计算提供基础数据。**常见的特征类型包括序列特征和代码结构特征。**

#### 序列特征预处理

包括信息熵评估、正则表达式转换、N-grams序列、序列向量化、权重量化法等，**序列特征预处理会将初始特征中冗余特征消除、特征语义表达式增强、特征量化等以便于进行相似性计算**。L. Wu通过**分析恶意软件敏感API操作以及事件等，将API序列特征转换为正则表达式**，并**在发生类似的正则表达式模式时检测恶意代码**。IBM研究小组先将**N-gram方法应用于恶意软件分析中，使用N-gram的统计属性预测给定序列中下个子序列，从而进行相似度计算**。Kolosnjaji等提出**对API调用序列进行N-gram处理获取子序列，采用N-gram方法将API调用序列转换为N-gram序列**，实现过程下图所示。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805232.png)

#### 代码结构特征预处理

在相似度比较时存在边、节点等匹配问题即子图同构算法复杂性，同时代码结构特征中存在冗余结构，因此**除去冗余、保留与恶意操作相关的代码结构是预处理的主要目的**。常见的方法包括API调用图预处理、CFG图预处理、PDG图预处理等。

### 3.相似性计算

溯源旨在通过分析样本的同源性定位到家族或作者，样本的同源性可以通过分析代码相似性来获取。**相似性计算旨在衡量恶意代码间相似度，具体为采用一种相似性模型对恶意代码的特征进行运算。**根据预处理特征类型的不同以及溯源需求、效率、准确性等差异，采用不同的相似性运算方法。

目前比较流行的相似性计算方法主要集中在对集合、序列、向量、图等特征表现形式的处理。Qiao等基于集合计算相似性，**在不同恶意样本API集合的相似性比较中采用了Jaccard系数方法，将为A、B两个集合的交集在并集中所占的比例作为相似度，比例值越大，证明越相似**，如公式所示.

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805708.png)

Faruki等提出了采用SDhash相似性散列技术构建样本的签名序列，并采用汉明距离法对序列进行相似性计算，从而识别同源性样本。Suarez-Tangil 等用数据挖掘算法中向量空间模型展示家族的恶意代码特征形式，将**同家族提取出来的具有代表性的CFG元素作为特征中维度，采用余弦算法对不同家族的向量空间模型进行相似度计算，根据余弦值来判断它们的相似性，从而识别出相似性样本，进而归属到对应的家族。用于比较向量的余弦相似度反映了恶意代码间的相似性**，其具体公式如公式所示。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805368.png)

Cesare等提出了最小距离匹配度量法，**比较不同样本的CFG图特征的相似性**。Kinable等通过**静态分析恶意代码的系统调用图，采用图匹配的方式计算图相似性得分**，该得分近似于图的编辑距离。利用该得分比较样本的相似性，采用聚类算法将样本进行聚类，实现家族分类。

### 4.同源判定

学术界常见的同源判定方法主要包括基于聚类算法的同源判定、基于神经网络的同源判定等。Kim等采用DBSCAN算法对基于调用图聚类，发现类似的恶意软件。Feizollah等提出采用层聚类算法，构建家族间演化模型，进而发掘家族功能的演化。Niu等提出了层次聚类和密度聚类算法结合的快速聚类算法对操作码序列特征进行聚类，以识别恶意软件变体，该方法识别变体效率较高。

神经网络是一种多层网络的机器学习算法，可以处理多特征以及复杂特征的同源判定。基本思想为：**将样本特征作为输入层数据，然后不断调整神经网络参数，直到输出的样本与该样本是一种同源关系未为止。**它会将恶意代码特征送输入层，即可判断恶意代码的同源性.。赵炳麟等提出了**基于神经网络的同源判定方法**，其整体实现框架如下图所示。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805818.png)

### 5.问题

最终目标是什么？是发现问题后根据积累的数据溯源？还是根据已有的数据实现防患于未然、未卜先知、主动防御？还是都要有？

数据集在哪里，其中有什么？日志、流量、恶意软件还是。。。有哪些特征？

怎么从数据集中提取特征，提取哪些特征？如果全部提取，时间花费。。。**结构化数据集**

如何根据知识图谱或专家知识、数据集或数据集中提取的特征生成**溯源图**，并且代码细节如何实现呢?有论文2020

如何根据一个运行中的系统中的系统日志、流量、api调用序列等等生成查询图？代码细节如何实现？

查询图和溯源图的匹配？

N-gram模型是不是最好的？能否进一步优化、或采用新模型？

现阶段是否已有一定基础可供利用？

。。。

总体步骤：

1、从（结构化的）知识图谱或专家知识（CTI报告）、（结构化的）数据集或数据集中提取的特征生成溯源图

2、根据一个运行中的系统中的系统日志、流量、api调用序列等等生成查询图

3、匹配与相似度计算

## 四、产业界恶意代码溯源

产业界除了采用与学术界类似的同源判定方法之外，还会通过关联的方法对恶意代码进行溯源。产业界的溯源意图除了溯源出编写恶意代码作者、恶意代码家族之外，还要挖掘出攻击者及攻击者背后的真正意图，从而遏制攻击者的进一步行动。

产业界与学术界溯源方法的差异主要表现在特征提取和同源判定两个方面：在特征提取上，产业界更倾向于从代码结构、攻击链中提取相似性特征；在同源判定上，除了采用与已有的历史样本进行相似度聚类分析之外，产业界还会采用一些关联性分析方法。相比学术界溯源特征，产业界溯源特征更加详细全面，信息复杂度大。因此，学术界的同源判定方法并不能完全用于产业界各类特征的相似性分析中，常见产业界溯源方法分类如下表所示。

![img](https://cdn.jsdelivr.net/gh/p0lar1star/blog-img/202204041805521.png)